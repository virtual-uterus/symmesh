# Symmesh
# Table of contents
1. [General description](#general)
2. [Requirements](#requirements)
3. [Usage](#usage)
	1. [Setup](#setup)
	2. [Running the code](#code)
		1. [Mesh information](#information)
		2. [Mesh conversion](#conversion)
		3. [Mesh annotation](#annotation)
4. [Improvements](#improvements)	
<a id="general"></a>
## General description
This package provides tools to analyse, convert, and generate fibres for .vtk meshes.

The project is structure as follows:
```
symmesh/ (top-level directory)
|-- scripts/ (contains the Python scripts)
|-- symmesh/ (contains the symmesh module)
|-- tests/ (contains tests)
```

<a id="requirements"></a>
## Requirements
The code was run on Linux Ubuntu 22.04.2 LTS\
The code was developed in [Python](https://www.python.org/) version 3.10.12\
The required packages for Python are found in requirements.txt
For the extraction of the data, [Paraview 5.13](https://www.paraview.org/) or any other version using Python 3.10 is required to be installed.

<a id="usage"></a>
## Usage
<a id="setup"></a>
### Setup
First clone the project into *symmesh* and enter the new directory:
```bash
$ git clone git@github.com/virtual-uterus/symmesh.git
```

It is recommended to create a virtual environment in which to run the code. Create a virtual environment and activate it:
```bash
$ python3 -m venv ~/venv/symmesh-env
$ source ~/venv/symmesh-env/bin/activate
```

To be able to include the Paraview Python packages, a path file needs to be added in the site-packages folder in the virtual environment. First navigate to the Paraview Python site-package, where /path/to/ParaView/ is the path to the installation location:
```bash
$ cd /path/to/ParaView/paraview-5.13.1/lib/python3.10/site-packages
```
Then, copy the path to a .pth file in the Python site-packages in the virtual environment:
```bash
$ pwd >> ~/venv/symmesh-env/lib/python3.10/site-packages/paraview.pth
```

Return to the symprobe folder and install the module with the following commands:
```bash
$ cd /path/to/symmesh
$ pip3 install -e .
```

Due to conflicts between Paraview and pyvista using different versions of the vtk package, it must be uninstalled for the package to work properly.
```bash
$ pip uninstall vtk
```

**Update the BASE variable in the symmesh/constants.py file to the path you need, otherwise the paths will not be correct.**

Run the test to make sure that the code is working properly:
```bash
$ pytest
```


<a id="code"></a>
### Running the code
<a id="information"></a>
#### Mesh information
Information can be extracted from a mesh using the __mesh-info.py__ script. There are two available subcommands: quality, to evaluate the quality of the mesh, and distance, to estimate the mean distance between elements and edge length.

There are four possible quality metrics for the quality subcommand: 
 * ar: aspect ratio,
 * mr: mean ratio,
 * ja: Jacobian determinant, and
 * sj: scaled Jacobian determinant.

This list is found in the **symmesh/constants.py** script as well. 

To see the arguments and options of the script and subcommands, use the --help flag:
```bash
$ python3 mesh-info.py --help
$ python3 mesh-info.py quality --help
$ python3 mesh-info.py distance --help
``` 
<a id="conversion"></a>
#### Mesh conversion
There are two scripts that will convert meshes. The first one, __cube-to-tet.py__ converts a mesh with hexahedron elements to tetrahedral elements. The second, __mesh-converter.py__, converts the format of a mesh from .vtu to .exnode and .exelem to be visualised in Cmgui.

To see the arguments and options of the scripts, use the --help flag:
```bash
$ python3 cube-to-tet.py --help
$ python3 mesh-converter.py --help
```

<a id="annotation"></a>
#### Mesh annotation
There are two scripts that will annotate meshes. The first one, __mesh-annotation.py__ script annotates a mesh (surface or volumetric) with the thickness data generated from micro-compute tomography data (see [uterine-microCT](https://github.com/virtual-uterus/uterine-microCT)). The second one, __fibre-annotation.py__ annotates a mesh (volumetric only) with the fibre orientation information from an .ortho file. The fibre orientation information can be extracted from micro-compute tomography data (see [uterine-microCT](https://github.com/virtual-uterus/uterine-microCT)) or generated for idealised meshes with the __fibre-generation.py__ script.

To see the arguments and options 
of the scripts, use the --help flag:
```bash
$ python3 mesh-annotation.py --help
$ python3 fibre-annotation.py --help
```
The supported file types for the mesh are .vtk, and .vtu.

<a id="fibre"></a>
#### Fibre generation
Fibre orientations can be generated by calling the __fibre-generation.py__ script which uses a Laplace-Dirichlet rule-based algorithm to generate fibres ([ldrb package](https://github.com/finsberg/ldrb)). This requires the ldrb package for which it is recommended to use a container with Singularity (see [Figshare](https://auckland.figshare.com/account/projects/241424/articles/28646171) for the container). However, the __fibre-generation.py__ script only works for scaled uterine scaffolds. It also requires the identification of the points on the outer surface of the mesh to be able to generate the fibre orientations. 

To see the arguments and options of the script, use the --help flag:
```bash
$ python3 fibre-generation.py --help
```
The supported file types for the mesh is .xml.

The __point-generation.py__ script generates the .csv files that are required to extract the fibre orientations from micro-computed tomography data (see [uterine-microCT](https://github.com/virtual-uterus/uterine-microCT)).

<a id="improvements"></a>
## Improvements
The mesh conversion scripts could be combined with subcommands: one to convert a mesh to tetrahedra, and one to convert to Cmgui format. \
The mesh annotation scripts could be combined with subcommands: one to annotate with thickness data, and one to annotate with fibre data. \
The fibre generation script could be more generic to work with more meshes rather than only the scaled scaffolds. \
More tests could be added. \
Error handling could be improved.